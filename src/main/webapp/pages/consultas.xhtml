<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

<ui:composition template="/templates/template.xhtml">
    <ui:define name="title">Consultas</ui:define>

    <ui:define name="content">
        <h:form id="formConsultas">
            <p:panel header="Consultar Medicamentos por Paciente">
                <p:panel header="Filtros" styleClass="p-mb-3">
                    <div class="p-fluid p-formgrid p-grid">
                        <div class="p-field p-col-12 p-md-5">
                            <p:outputLabel for="filtroPaciente" value="Paciente:"/>
                            <p:selectOneMenu id="filtroPaciente"
                                             value="#{receitaBean.filtroPacienteId}"
                                             converter="uuidConverter"
                                             filter="true"
                                             filterMatchMode="contains">
                                <f:selectItem itemLabel="Todos" itemValue="#{null}"/>
                                <f:selectItems value="#{receitaBean.pacientes}"
                                               var="p"
                                               itemValue="#{p.id}"
                                               itemLabel="#{p.nome}"/>
                            </p:selectOneMenu>
                        </div>

                        <div class="p-field p-col-12 p-md-5">
                            <p:outputLabel for="filtroMedicamento" value="Medicamento:"/>
                            <p:selectOneMenu id="filtroMedicamento"
                                             value="#{receitaBean.filtroMedicamentoId}"
                                             converter="uuidConverter"
                                             filter="true"
                                             filterMatchMode="contains">
                                <f:selectItem itemLabel="Todos" itemValue="#{null}"/>
                                <f:selectItems value="#{receitaBean.medicamentos}"
                                               var="m"
                                               itemValue="#{m.id}"
                                               itemLabel="#{m.nome}"/>
                            </p:selectOneMenu>
                        </div>

                        <div class="p-field p-col-12 p-md-2">
                            <p:outputLabel value=" "/>
                            <div>
                                <p:commandButton value="Pesquisar"
                                                 icon="pi pi-search"
                                                 action="#{receitaBean.pesquisar}"
                                                 update="tabelaConsultas"
                                                 styleClass="p-button-block"/>
                            </div>
                        </div>
                    </div>
                </p:panel>

                <p:dataTable id="tabelaConsultas"
                             value="#{receitaBean.lazyModel}"
                             var="receita"
                             lazy="true"
                             paginator="true"
                             rows="10"
                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             rowsPerPageTemplate="5,10,15,20"
                             emptyMessage="Nenhuma receita encontrada"
                             styleClass="table-responsive">

                    <p:column headerText="Data" style="width: 120px">
                        <h:outputText value="#{receita.dataPrescricao}">
                            <f:converter converterId="localDateConverter"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Paciente">
                        <h:outputText value="#{receita.paciente.nome}"/>
                    </p:column>

                    <p:column headerText="CPF" style="width: 150px">
                        <h:outputText value="#{receita.paciente.cpf}">
                            <f:converter converterId="cpfConverter"/>
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Total de Medicamentos" style="width: 180px; text-align: center">
                        <p:badge value="#{receita.medicamentosReceitados.size()}" severity="info"/>
                    </p:column>

                    <p:column headerText="Medicamentos">
                        <ui:repeat value="#{receita.medicamentosReceitados}" var="mr">
                            <p:chip label="#{mr.medicamento.nome}" styleClass="p-mr-2 p-mb-2"/>
                        </ui:repeat>
                    </p:column>

                    <p:column headerText="Ações" style="width: 80px; text-align: center">
                        <p:commandButton icon="pi pi-eye"
                                         styleClass="ui-button-info"
                                         title="Visualizar Detalhes"
                                         action="#{receitaBean.visualizar(receita)}"
                                         process="@this"
                                         update=":formConsultas:dlgDetalhesConsultaContent"
                                         oncomplete="PF('dlgDetalhesConsulta').show()"/>
                    </p:column>
                </p:dataTable>
            </p:panel>

            <p:dialog header="Detalhes da Receita"
                      widgetVar="dlgDetalhesConsulta"
                      modal="true"
                      responsive="true"
                      width="800">
                <p:outputPanel id="dlgDetalhesConsultaContent">
                    <div class="receita-detalhes">
                        <h:panelGrid columns="2" styleClass="detail-grid">
                            <h:outputText value="Data da Prescrição:" styleClass="label"/>
                            <h:outputText value="#{receitaBean.receitaSelecionada.dataPrescricao}">
                                <f:converter converterId="localDateConverter"/>
                            </h:outputText>

                            <h:outputText value="Paciente:" styleClass="label"/>
                            <h:outputText value="#{receitaBean.receitaSelecionada.paciente.nome}"/>

                            <h:outputText value="CPF:" styleClass="label"/>
                            <h:outputText value="#{receitaBean.receitaSelecionada.paciente.cpf}">
                                <f:converter converterId="cpfConverter"/>
                            </h:outputText>

                            <h:outputText value="Total de Medicamentos:" styleClass="label"/>
                            <h:outputText value="#{receitaBean.receitaSelecionada.medicamentosReceitados.size()}"/>
                        </h:panelGrid>

                        <p:divider/>

                        <h4>Medicamentos Prescritos</h4>

                        <p:dataTable value="#{receitaBean.receitaSelecionada.medicamentosReceitados}"
                                     var="mr"
                                     styleClass="p-mt-2">
                            <p:column headerText="Medicamento" style="width: 300px">
                                <h:outputText value="#{mr.medicamento.nome}" styleClass="font-bold"/>
                            </p:column>

                            <p:column headerText="Posologia">
                                <h:outputText value="#{mr.posologia}"/>
                            </p:column>
                        </p:dataTable>
                    </div>
                </p:outputPanel>
            </p:dialog>
        </h:form>
    </ui:define>
</ui:composition>
</html>
